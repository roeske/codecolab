{% include "header.html" %}
{% include "project_navbar.html" %}
<script src="//ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js">
</script>
<script src="//netdna.bootstrapcdn.com/bootstrap/3.0.0/js/bootstrap.min.js">
</script>
<div class="container _content">
  <div class="row _flexrow">
    <div id="__project_navbar" class="bs-docs-sidebar">
        <ul class="nav nav-pills nav-stacked affix-top" id="__project_sidenav">
        {% for p in projects %} {% if p._id == luser.last_project_id %}
            {% set active = "active" %}
          {% endif %}
          <li class="_project_nav_link {{ active }}">
          {% set active = "" %}
            <a data-id="{{ p._id }}" class="active">
              {{ p.name }}
              <div class="clearfix"></div>
            </a>
          </li>
        {% endfor %}
        </ul>
        <div class="_toggle_side" id="__toggle_project_selection">
            <div>
              <i class="glyphicon glyphicon-chevron-right"></i>
            </div>
        </div>
    </div>

    <div id="__project_wrapper">
      <div id="__project_page_container">
      </div>
    </div>
    <div class="clearfix"></div>
  </div>
</div>
</div> 
{% include "footer.html" %}

<script src="//tinymce.cachefly.net/4.0/tinymce.min.js"></script>
<script type="text/javascript">
// <jinja2>
var last_project_id = {{ luser.last_project_id }};
var last_tab = "{{ luser.last_tab }}";
// </jinja2>

$(".container").css("max-width", "none");

// stub so we can replace with nicer alert.
function cc_alert(msg) {
  alert(msg);
}

function px_to_int(px_str) {
  if (px_str === undefined) return 0;
  return parseInt(px_str.replace("px", ""), 10);
}

function calculate_max_height() {
  // call this code in the repl after loading the page to calculate the value 
  // for margin:
  // px_to_int($("#__subnav").css("margin-top"));
  var bottom_padding = 30; // Leave it, this represents the negative space below the 
                           // content area.
  var margin = 40;
  var diff = + $("#__subnav").height() + margin + bottom_padding;
  return window.innerHeight - diff;
}

function update_selection_dimensions() {
  $("#__project_navbar").css("min-height", calculate_max_height());
  $("#__toggle_project_selection > div").css("margin-top", $("#__toggle_project_selection").height() / 2 - 14);
}

function load_project_page(tab, project_id) {
  // it's a kludge but it works.
  if (tab != "boards") {
    $("#__add_pile_form").fadeOut();
  } else {
    $("#__add_pile_form").fadeIn("slow");
  }
  $("#__project_page_container").load("/project_id/" + project_id + "/" + tab);
}


$(document).ready(function() {
  update_selection_dimensions();
  $(window).resize(update_selection_dimensions);
  
  // handle switching projects
  //----------------------------------------------------------------------
  $("._project_nav_link").click(function() {
    var link = $(this).find("a");
    $("#__project_name").text(link.text());
    var project_id = link.data("id");

    if (project_id != last_project_id) {
      $("._project_nav_link").removeClass("active");
      $(this).addClass("active");

      load_project_page(last_tab, project_id);
      last_project_id = project_id;
    }

    return false;
  });

  // handle switching project pages, via tabs
  //----------------------------------------------------------------------
  $("._tab").click(function() {
    var tab = $(this).data("tab"); 
    if (tab != last_tab) {
      $("._tab").removeClass("active");
      $(this).addClass("active");       
      load_project_page(tab, last_project_id);
      last_tab = tab;
    }
  });

  $("#__toggle_project_selection").click(function() {
    $("#__project_sidenav").toggle();
  });

  // Load the correct project name when the page is loaded.
  $("#__project_name").text($("a[data-id="+last_project_id+"]").text());

  // Load project content for correct tab when the page is loaded.
  load_project_page(last_tab, last_project_id);
});

</script>

<script src="//cdnjs.cloudflare.com/ajax/libs/fancybox/2.1.5/jquery.fancybox.min.js">
</script>
</body>
</html>
