<div class="_boards_container">
  <div class="_piles_container" id="__piles_container">
    <div id="__piles_wrapper">
      {% for p in piles %}
          <div class="col-md-4 _pile">
            <div class="panel panel-default">
              <div class="panel-heading _handle">
                <div class="pull-left _pile_name">
                  {{ p.name }} 
                </div>
                <div class="pull-right">
                  <i class="glyphicon glyphicon-remove"></i>
                </div>
                <div class="clearfix"></div>
              </div>
              <div class="panel-body">
                <div class="_cards_wrapper">
                {% for card in p.cards %}
                  {% if not card.is_archived %}
                    {% include "minicard.html" %}
                  {% endif %}
                {% endfor %}
                </div>
              </div>
            </div>
        </div>
      {% endfor %}
    </div>
    <div class="clearfix"></div>
  </div>
</div>

<script src="/js/socket.io.js"></script>
<script src="/js/jquery-ui.js"></script>
<script>
var SOCKETIO_SERVER = "http://192.241.181.165:8080"

function calculate_pile_container_width() {
  var piles = $("._pile");
  if (piles.length == 0) {
    return 0;
  } else {
    var total = 0;
    $("._pile").each(function(i,elem) {
      total += px_to_int($(elem).css("width"));
      total += px_to_int($(elem).css("margin-left"));
      total += px_to_int($(elem).css("margin-right"));
    });
    return total;
  }
}

function get_height_of_tallest_pile() {
  var piles = $("._pile");
  var tallest = 0;
  if (piles.length == 0) {
    return tallest;
  } else {
    $("._pile").each(function(i,elem) {
      var elem_height = $(elem).height();
      if (elem_height > tallest) {
        tallest = elem_height;
      }
    });
    return tallest;
  }
}

function update_board_dimensions() {
  var max_height = calculate_max_height();

  $("._boards_container").height(max_height - 0);
  $("._piles_container").css("overflow-y", "hidden");
  $("._piles_container").height(max_height - 0);

  // Calculate perfect height for card scrolling containers.

  // The magic number 60 is kind of ugly, but it stands for some combination
  // of the 15 px margins that exist. Just keep them at 15 for now. It looks nice
  // anwyway.
  $("._cards_wrapper").css("max-height", max_height - 60 -
    $("._pile .panel-heading").height()).css("overflow-y", "auto");

  $("#__piles_wrapper").width(calculate_pile_container_width());
  var height = get_height_of_tallest_pile();
  $("#__piles_wrapper").height(height);
  $("._pile").height(height);
}

$(document).ready(function() { 
  var project_id = {{ project._id }};

  // Initialize board dimensions.
  $("._pile").css("float", "left");
  $("._pile").css("width", "370px");
  $(".panel-body").css("overflow-y", "auto");
  $("#__piles_container").width("100%");
  $("._boards_container").css("overflow-y", "hidden");
  update_board_dimensions();

  // Keep board dimensions updated when resizing the window.
  $(window).resize(update_board_dimensions);

  // Initialize socket.io
  var socket = io.connect(SOCKETIO_SERVER);
  socket.on("ready", function(data) {
      socket.emit("observe_project", {project_id: project_id});
  });
  socket.on("add_card", function(data) {});
  socket.on("archive_card", function(data) {});
  socket.on("reorder_cards", function(data) {});
  socket.on("reorder_piles", function(data) {});
  socket.on("delete_pile", function(data) {});
  socket.on("add_pile", function(data) {});


  // Initialize pile sorting.
  $("#__piles_wrapper").sortable({
    delay: 100,
    distance: 10,
    revert: "invalid",
    tolerance: "pointer",
    handle: "._handle",
    placeholder: "_pile_placeholder",

    start: function(e, ui) {
      ui.placeholder.height(ui.helper.outerHeight());
      ui.placeholder.width(ui.helper.outerWidth());
    },

    stop: function(event, ui) {

    }
  });

  $("._cards_wrapper").sortable({
    delay: 100,
    distance: 10,
    revert: "invalid",
    tolerance: "pointer",
    placeholder: "_card_placeholder",
    connectWith: "._cards_wrapper",

    start: function(e, ui) {
      ui.placeholder.height(ui.helper.outerHeight());
      ui.placeholder.width(ui.helper.outerWidth());

    },

    stop: function(e, ui) {

    }
  });
});
</script>
