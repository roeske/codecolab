{% include "head.html" %}
<div class="content">
  <h3>Office Hours: {{ project_name }}</h3>
  <div class="clear"></div>

  <div class="days">
    {% for day in days %}
      <div class="day">{{ day.name }}</div>
    {% endfor %}
  </div>
  <div class="clear"></div>
  <div class="timefriend">
    {% for member in sorted_members %}
      {% set luser = member.luser %}
      <div>
        <div class="luser_time">
          <div class="left">
            <img class="avatar" src="{{ luser.small_gravatar_url }}" />
          </div>
          <div class="left">
            <div class="username">{{ luser.profile.username }}</div>
            <div>{{ luser.profile.tz_utc_offset_human }}</div>
            <div class="time" data-tz="{{ luser.profile.tz_utc_offset_seconds }}"></div>
            <div class="date" data-tz="{{ luser.profile.tz_utc_offset_seconds }}"></div>
          </div>
          <div class="clear"></div>
        </div>
        <div class="hours">
          {% for hour in member_hours[member.luser_id] %}
            <div data-luser-id="{{ member.luser_id }}" data-hour="{{ hour }}" class="hour">
              <div class="inner">
                <div data-hour="{{ hour }}" class="hour_of_day">{{ hour }}</div> 
                <div data-hour="{{ hour }}" class="am_pm"></div>
              </div>
            </div>
          {% endfor %}
          <div class="clear"></div>
        </div>
        <div class="clear"></div>
      </div> {% endfor %}
  </div>
</div>

{% include "common_js.html" %}

<script type="text/javascript">
var MONTHS = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug",
              "Sep", "Oct", "Nov", "Dec"]


function convert(now, offset) {
    var msecs = now.getTime()    
    return new Date(msecs + offset * 1000)
}

function pad(n) {
    if (n < 10) 
        return "0" + n
    else
        return "" + n
}


// returns naive 24 hour time as string
function current_time(now, offset) {
    var converted = convert(now, offset)
    var hour = pad(converted.getHours())
    var minute = pad(converted.getMinutes())
    var seconds = pad(converted.getSeconds())

    return hour + ":" + minute + ":" + seconds
}


// returns naive date as string
function current_date(now, offset) {
    var converted = convert(now, offset)
 
    // build formatted date string:
    var month = MONTHS[converted.getMonth()]
    var day_of_month = converted.getDate()
    var year = converted.getFullYear()

    var date_format = month + " " + day_of_month + ", " + year
    return date_format    
}

function utcnow() {
    var now = new Date()
    return new Date(now.getTime() + now.getTimezoneOffset() * 60000);
}


function update_timestamps() {
    var now = utcnow()

    $(".date").each(function(i, elem) {
        var offset = Number($(elem).data("tz"))
        $(elem).text(current_date(now, offset))
    })

    $(".time").each(function(i, elem) {
        var offset = Number($(elem).data("tz"))
        $(elem).text(current_time(now, offset))
    })
}


function keep_timestamps_updated() {
    update_timestamps()
    setTimeout(keep_timestamps_updated, 1000)
}


function setup_12_hour_times()
{
  $(".hour_of_day").each(function(i, elem) {
      var hour = $(elem).data("hour")

      if (hour > 12) {
          hour = hour - 12
      } else if (hour == 0) {
          hour = 12
      }

      $(elem).text(hour)
  })

  $(".am_pm").each(function(i, elem) {
      var hour = $(elem).data("hour")

      if (hour < 12) {
          $(elem).text("am") 
      } else {
          $(elem).text("pm")
      }
  })
}

$(function() {
    setup_12_hour_times()
    update_timestamps()
    keep_timestamps_updated()
    
    var luser_id = {{ luser._id }}
    $(".hour").click(function(ev) {
        var hour_luser_id = $(this).data("luser-id")

        // only allow the changing of our own hours
        var is_on = $(this).data("is-on")

        if (hour_luser_id == luser_id && !is_on) {
            $(this).addClass("on")
            $(this).data("is-on", true)
        } else if (hour_luser_id == luser_id) {
            $(this).removeClass("on")
            $(this).data("is-on", false)
        }
    })
})

</script>
{% include "foot.html" %}
