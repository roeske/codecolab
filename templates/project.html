{% include "head.html" %}
<div class="content">
  <div id="subnav">
  <div id="project_name">
    <h3><a href="#">
    <div class="icon">&#128196;</div>
    &nbsp;{{ project.name }}</a></h3>
  </div> 
  <div class="buttons">
    <a href="/project/{{ project.urlencoded_name }}/archives"
     class="btn">
     <div style="float; left"> Archives&nbsp;</div>
     <div class="icon">&#59392;</div>
    </a>
  </div>

  <div style="padding-top: 7px;" id="toolbox">
    <form action="/piles/add" method="POST">
    <input type="hidden" name="project_name" value="{{ project.name }}" />
    <ul id="toolbox-list" class="controls structural horizontal_right">
      <li>
      <input type="submit" name="submit" value="Add Pile " class="btn"/>
      </li>
      <li>
      <input type="text" placeholder="Pile Name..." name="text" id="text"/>
      </li>
    </ul>
    </form>
  </div>
  </div>

  <div class="clear"></div>

  <div id="piles">
  <ul id="pile_list">

  {% for pile in project.piles %}
    <li class="pile_container" data-id="{{ pile._id}}" data-number="{{ pile.number }}">

    <div class="handle chrome pile_chrome_top top_corners">
      <h4 class="pile_title"><span data-id="{{ pile._id }}" class="editable pile_title">{{ pile.name }}</span></h4>
      <div class="pile_options">
      <a href="/delete?pile_id={{ pile._id }}&project_name={{ project.urlencoded_name
      }}">&nbsp;<span class="icon">&#10060;</span>&nbsp;</a>
      </div>
    </div>
    <div class="clear"></div>

    <ul id="{{ pile.pile_uuid }}" data-id="{{ pile._id }}" class="card_list">
      {% for card in pile.cards %}
        {% include "minicard.html" %}
      {% endfor %}
    </ul>

    <div class="chrome pile_chrome_bottom bottom_corners">
      <form data-pile-id="{{ pile.pile_uuid }}" class="add_card" action="/project/{{ project.name }}/cards/add" method="POST">
      <input type="hidden" name="project_name" value="{{ project.name }}" />
      <input type="hidden" name="pile_id" value="{{ pile._id }}" />

      <div class="clear"></div>
      <ul class="add_card structural">
        <li class="input"> 
        <input type="text" class="add_card" placeholder="I'm going to..." name="text" id="text"/>
        </li>
        <li class="button">
        <input type="submit" name="submit" value="Add Card " class="btn"/>
        </li>
      </ul>
      </form>
    </div>
    </li>
  {% endfor %}

  </ul>

  </div>

  {% include "activity.html" %}

</div>

{% include "common_js.html" %}

<!-- BEGIN: JS -->
<script type="text/javascript" src="/pagedown/Markdown.Converter.js"></script>
<script type="text/javascript" src="/pagedown/Markdown.Sanitizer.js"></script>
<script type="text/javascript" src="/pagedown/Markdown.Editor.js"></script>

<script type="text/javascript" src="/js/project.js"></script>
<script type="text/javascript">

function handle_archive_click(event) {
    event.preventDefault()

    var that = this;
    $.ajax({
        type: "GET",
        url: $(this).attr("href"),
        
        success: function(data) {
            $(that).parent().parent().remove()
            cc_activity_reload()
        },

        contentType: "application/json;charset=UTF-8"
    })
}

// Run this code when the DOM is ready.
$(function() {
  // We need to set the width of the pile list to the length of all the 
  // piles. This is because some browsers will make the inner list too
  // small and cause it not to contain all of them horizontally.
  // Mainly, firefox.
  var total_width = 0
  $(".pile_container").each(function(i, elem) {
      total_width += $(elem).width()
  })
  console.log("total_width="+total_width)

  // Now set the inner #pile_list width to the total width
  $("#pile_list").width(total_width)


  // Make to-do lists sortable by dragging and save changes in the database.
  // Read pile ids via jinja2.
  pile_ids = {{ json_pile_ids|safe }}
  
  // Obtain reference to the project's name 
  project_name = "{{ project.name }}"

  // Initialize project page
  cc_project_init(project_name, pile_ids) 

  $(".editable.difficulty").each(function(i, elem) {
    elem = $(elem)
    cc_connect_raty_score(elem, project_name, elem.data("card-id"), false)
  })


  // Handle clicks on 'archive' buttons 
  // -- update server
  // -- remove element from dom on success.
  $("a.archive").click(handle_archive_click)


  // Append new cards to the bottom of the pile via AJAX.
  $("form.add_card").each(function(i, elem) { 

      var pile_selector = "#" + $(elem).data("pile-id")

      $(elem).ajaxForm({
          success: function(text) {
              // Add the card.
              $(pile_selector).append(text)

              // Scroll to the bottom so the card is visible.
              $(pile_selector).scrollTop($(pile_selector)[0].scrollHeight)

              // Select the newly added card.
              var selector = $(pile_selector + " li.card_item")
              var selector_func = function() { return selector }

              // Update the order of the cards (there is an ordinal that
              // needs to be set on each card to correctly designate its
              // order, independent of how it is currently rendered)
              var updates = cc_cards_reorder_update_dom(selector_func)

              // Update the above on the server.
              cc_reorder_post("cards", updates)

              // Select the last card (newly added), so we can hook up its controls.
              var selector = pile_selector + " li.card_item:last"
              cc_connect_card(selector)
              
              // Connect the raty widget when adding a new card via ajax.
              var elem = $($(selector).find(".difficulty"))
              cc_connect_raty_score(elem, project_name, elem.data("card-id"))

              // Handle archive clicks on the new card.
              $($(selector).find("a.archive")).click(handle_archive_click)

              // Make the new card border glow a bit when it is first shown.
              var color = "#4DCDFF" // blue
              var width = "2px"

              var temporary = { 
                  borderTopColor: color, 
                  borderTopWidth: width, 
                  borderLeftColor: color,
                  borderLeftWidth: width,
                  borderRightColor: color,
                  borderRightWidth: width,
                  borderBottomColor: color,
                  borderBottomWidth: width
              }

              var invisible = "rgba(0,0,0,0);"

              var invisible = { 
                  borderTopColor: invisible, 
                  borderLeftColor: invisible,
                  borderRightColor: invisible,
                  borderBottomColor: invisible 
              }

              $(selector).animate(temporary, 'slow', function() {
                  $(selector).animate(invisible, 'slow')
              })

              // Reset the add card textbox after the card is added.
              $("input.add_card").val("")
          } 
      })
  })

    cc_setup_activity_toggle()
    cc_setup_activity_links()
})
</script>
<!-- END: JS -->

</body>
</html>
