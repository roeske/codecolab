<!DOCTYPE html>
<html>
    <head>
        <title>CodeColab</title>
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
        <meta name="viewport" content="width=device-width, initial-scale=1.0"/>

        <link href="http://fonts.googleapis.com/css?family=Lato:300,400,700,900,300italic,400italic,700italic,900italic" rel="stylesheet" type="text/css"/>
        
        <link href="/css/lib/animate.css" rel="stylesheet" type="text/css"  media="screen, projection"/>
        <link href="/css/sign-in.css" rel="stylesheet"  type="text/css" media="screen"/>
        <link href="/css/bootstrap.css" rel="stylesheet"/>
        <link href="/css/theme.css" rel="stylesheet" type="text/css" />

        <!--[if lt IE 9]>
            <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
        <![endif]-->
        <link href="http://code.jquery.com/ui/1.10.0/themes/base/jquery-ui.css" type="text/css" rel="stylesheet"/>

        <script type="text/javascript" src="http://code.jquery.com/jquery-latest.js"></script>
        <script type="text/javascript" src="http://code.jquery.com/ui/1.10.0/jquery-ui.js"></script>
        <script type="text/javascript" src="/js/bootstrap.min.js"></script>
        <script type="text/javascript" src="/js/theme.js"></script>


        <!-- mine -->
        <link href="/css/app.css" type="text/css" rel="stylesheet"/>

<!-- Begin application code -->
<script type="text/javascript">

/** 
 * Creates an object suitable for passing to jQuery UI's 'sortable' method
 * for the purpose of updating the sort order of cards on the backend.
 */
function make_sortable(selector) {
    var children = function() { 
        return $(selector + " li.card_item").not("li.ui-sortable-placeholder") 
    }
    
    var indexes_to_sort_keys =  {}

    var that = {
        delay: 1000,
        distance: 10,
        revert: "invalid",
        connectWith: "ul.card_list",
        tolerance: "pointer",
        placeholder: "empty_card",
        containment: "window",

        start: function(event, ui) {
            console.log("start")
            indexes_to_sort_keys = {}
            // Create a map of indexes to ids, used to find the changes in the
            // list order after the user finishes dragging the element.
            children().each(function(index, value) {
                var pile_id = $(value).parent().attr("data-id")
                var number = $(value).attr("data-number")
                indexes_to_sort_keys[index] = number 
            })
        },

        stop: function(event, ui) {
            console.log("stop")
            
            // Find the differences in the initial state of the list
            // and the current state, and upload a list of ids to 
            // set the new sort number on.
            var updates = []

            children().each(function(index, value) {
                var _id = $(value).attr("data-id")
                var pile_id = $(value).attr("data-pile-id")

                var number = indexes_to_sort_keys[index]
                // Save the change to send to the server and update in the
                // database.
                updates.push({ _id: _id, pile_id: pile_id, number: number})

                // Change the old data-number in the DOM to reflect the
                // new value after the sort operation.
                $(value).attr("data-number", number) 
            })


            // Post the updates to the "/cards/reorder" API
            $.ajax({
                type: "POST",
                url: "/cards/reorder", 
                data: JSON.stringify({updates: updates}),
                
                success: function(data) {
                    console.log(JSON.stringify(data))
                },

                contentType: "application/json;charset=UTF-8"
            })
        }
    }

    return that
}


function make_droppable(selector) {
    var select = function() { return $(selector) }

    var that = {
        drop: function(event, ui) {
            console.log("drop")
            // Update the dom node with the new pile id.
            var pile_id = select().attr("data-id")
            $(ui.draggable).attr("data-pile-id", pile_id)
            is_dropped = true
            $(ui.draggable).draggable(make_draggable(ui.draggable))
        }
    }

    return that
}


function make_draggable(selector) {
    var select = function() { return $(selector) }

    console.log(selector)
    var that = { 
        connectToSortable: "ul.card_list:not(:has("+select().attr("id")+"))",
        helper: "clone",
        revert: "invalid",

        start: function(event, ui) {
            console.log("start drag")
            elem = select()
            elem.hide()
        },
    
        drag: function(event, ui) {
            console.log("drag")
            // Multiple drop events can occur, so make sure
            // to unset is_dropped every time we move the
            // draggable. I hate this API.
            is_dropped = false
        },

        stop: function(event, ui) {
            console.log("stop drag")
            elem.show()

            if (is_dropped) {
                elem.remove()
            }
        }
    }

    select().draggable(that)
}

function setup_drag_and_drop() {
    // Make to-do lists sortable by dragging and save changes in the database.
    // Read pile ids via jinja2.
    pile_ids = {{ json_pile_ids|safe }}

    // Iterate pile ids and make sortable + droppable.
    for (var key in pile_ids) {
        id = pile_ids[key]
       
        // Build selector.
        var selector = "#" + id
        
        // Make the target list sortable.
        $(selector).sortable(make_sortable(selector)).disableSelection()
        $(selector).droppable(make_droppable(selector)).disableSelection()
    }

    $("li.card_item").each(function(i, elem) {
        $(elem).draggable(make_draggable(elem))
    })

    $("ul, li").disableSelection()
}

// Run this code when the DOM is ready.
$(document).ready(function() {
    setup_drag_and_drop() 
})

</script>
<!-- End application code -->

    </head>
    <body>
        <div class="navbar">
            <div class="navbar-inner">
                <div class="container">
                    <a class="brand" href="/">CodeColab</a>
                    <ul style="float: right" class="nav">
                        <li>
                            <a href="{{ profile_url }}">
                                <img style="height: 24px; width: 24px; float: left;" src="{{ gravatar_url }}" />
                                &nbsp;&nbsp;&nbsp;{{ email }}
                            </a>
                        </li>
                        <li>
                            <a href="/logout">Log out</a>
                        </li>
                    </ul>
                    <div class="clear"></div>
                </div>
            </div>
        </div>
        <div class="content">
            <div id="top_container">
                <div id="project_name">
                    <h1 >{{ project.name }}</h1>
                </div>

                <div id="toolbox">
                    <form action="/piles/add" method="POST">
                        <input type="hidden" name="project_name" value="{{ project.name }}" />
                        <ul id="toolbox-list" class="structural horizontal_right">
                            <li>
                                <input style="margin-left: .35em" type="submit" name="submit" value="Add Pile" class="btn"/>
                            </li>
                            <li>
                                <input type="text" placeholder="Pile Name..." name="text" id="text"/>
                            </li>
                        </ul>
                    </form>
                </div>
            </div>

            <div class="clear"></div>

            <div id="piles">
            {% for pile in project.piles %}
                <div class="pile_container">

                    <div class="chrome pile_chrome_top top_corners">
                        <h4>{{ pile.name }}</h4>
                    </div>

                    <ul id="{{ pile.pile_uuid }}" data-id="{{ pile._id }}" class="card_list">

                        {% for card in pile.cards %}
                            <li data-pile-id="{{ card.pile_id }}" id="{{ card.card_uuid }}" class="card_item ui-state-default"
                                data-id="{{ card._id }}" data-number="{{ card.number }}">
                            
                            <p class="date">{{ card.created_human }}</p>
                            <p class="text">{{ card.text }}</p>
                            
                            <a class="delete" 
                               href="/delete?card_id={{ card._id }}&project_name={{ project.urlencoded_name }}">delete</a>
                            <div style="clear: both"/></div>
                        {% endfor %}

                    </ul>

                    <div class="chrome pile_chrome_bottom bottom_corners">
                        <form action="/cards/add" method="POST">
                            <input type="hidden" name="project_name" value="{{ project.name }}" />
                            <input type="hidden" name="pile_id" value="{{ pile._id }}" />

                            <div class="clear"></div>
                            <ul class="controls structural horizontal_right">
                                <li>
                                    <input type="submit" name="submit" value="Add Card" class="btn"/>
                                </li>
                                <li> 
                                    <input type="text" placeholder="I'm going to..." name="text" id="text"/>
                                </li>
                            </ul>

                            <div class="clear"></div>

                        </form>
                    </div>
                </div>
            {% endfor %}
            </div>
        </div>
    </body>
</html>
